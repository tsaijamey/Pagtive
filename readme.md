# Pagtive 项目

## 项目目标
这是一个构建 Active Page 的项目。
Active Page 指的是通过接入LLM（主要是 Claude）实现用于演示的、包含动态可交互效果的 Page。
Page 的概念来自于 PPT 内容的"每一页"，一个 Page 是一个"舞台"，"舞台"上的元素参与内容演示，以达到描述某种概念、故事、场景等的效果。
Active Page 应该专注于使用 html + css + 原生的 js + svg 来实现内容，每个 Page 对应一个技术术语中的"元素容器"。html+css 实现的是元素容器和布局以及样式，js 实现交互，svg 实现一些特定的图标元素。
此外，Active Page 还应该可以使用本地相对路径或 CDN 链接的图片、图标等文件元素，以支撑更丰富的内容呈现需求。

本项目主要解决的是，基于该项目提供的交互式工具，为用户生成一个具体的 page codeproject，用户在这个codeproject中，可以通过提示词，要求大模型按照指定的风格、内容要求、布局要求、交互要求，生成实现对应内容展示的代码，并由本项目提供的根容器进行加载，为用户展示预览效果。最终用户得到的是一个代码包，包含了演示内容所需的 html/css/js/svg 等文件，用户只需要双击 start.html 即可从第一页开始展示内容。

## 技术方案

### 1. 技术栈选择

#### 1.1 开发框架
- **Next.js**：选择 Next.js 作为主框架
  - 提供优秀的开发体验和工程化能力
  - 支持服务端渲染，有利于预览功能实现
  - 内置路由系统，方便管理多页面应用
  - 良好的 TypeScript 支持

#### 1.2 核心依赖
- **Node.js**：作为运行时环境和构建工具基础
- **TypeScript**：提供类型安全和更好的开发体验
- **Anthropic SDK**：Claude API 的官方 SDK
- **Prettier & ESLint**：代码格式化和质量控制
- **Jest**：单元测试框架

#### 1.3 工具链
- **esbuild**：快速的代码打包工具
- **chokidar**：文件监听功能
- **commander**：CLI 工具开发
- **ws**：WebSocket 支持实时预览

### 2. 系统架构设计

#### 2.1 核心组件
- **代码生成引擎**：与 LLM 交互，将用户需求转换为具体的代码实现
  - 基于 prompt 工程优化代码生成质量
  - 支持增量代码生成和修改
  - 代码质量自动检查

- **预览容器**：加载生成的代码并提供实时预览功能
  - 基于 Next.js 的动态路由实现预览系统
  - 支持热重载和实时更新
  - 提供独立的沙箱环境

- **项目打包工具**：将生成的代码文件打包成可独立运行的项目
  - 智能依赖分析和打包
  - 资源文件优化
  - 生成独立可运行的项目包

#### 2.2 交互流程
1. 用户通过 CLI 或 Web 界面输入需求
2. LLM 分析需求并生成代码方案
3. 预览系统实时展示效果
4. 用户确认后打包输出最终代码

### 3. 项目结构

```
pagtive/
├── packages/
│   ├── core/           # 核心功能模块
│   ├── cli/           # 命令行工具
│   ├── preview/       # 预览系统
│   └── templates/     # 代码模板
├── apps/
│   └── web/           # Web 界面
└── examples/          # 示例项目
```

### 4. 开发流程

#### 4.1 本地开发
- 支持本地开发环境快速启动
- 提供开发服务器和热重载
- 集成调试工具和日志系统

#### 4.2 代码生成
- 基于模板系统生成基础代码
- 通过 LLM 进行代码优化和定制
- 支持代码增量更新和实时预览

#### 4.3 项目打包
- 生成标准的项目结构
- 优化资源文件和依赖关系
- 确保生成的项目可独立运行

### 5. 部署方案

#### 5.1 开发环境
- 本地开发服务器
- 热重载支持
- 调试工具集成

#### 5.2 生产环境
- 支持容器化部署
- 提供 CLI 工具的 npm 包
- 可选的在线服务部署方案

### 6. 前期准备工作

#### 6.1 技术验证要点

##### 核心功能验证
- 基于 Next.js 的代码预览系统
  - 动态加载生成的代码
  - 实时预览效果
  - 沙箱环境隔离

- 项目打包功能
  - 文件组织结构
  - 资源文件处理
  - 依赖关系处理

##### 工程化验证
- 开发环境配置
  - Next.js + TypeScript 开发环境
  - 热重载功能
  - 调试工具集成

- CLI 工具开发
  - 项目脚手架
  - 命令行交互
  - 文件监听和自动重载

#### 6.2 MVP 开发规划

##### 第一阶段：基础框架搭建
- 搭建 Next.js 项目框架
- 实现基础预览容器
- 完成项目脚手架

##### 第二阶段：核心功能开发
- 实现代码预览系统
- 开发项目打包功能
- 完成 CLI 工具基础功能

##### 第三阶段：功能完善
- 优化预览体验
- 完善打包功能
- 提供示例项目

### 7. 沙箱预览系统

#### 7.1 架构设计
沙箱预览系统是项目的核心组件之一，用于安全地加载和预览用户生成的代码。系统采用以下架构设计：

##### 核心组件
- **CodePreviewSandbox**：沙箱容器组件
  - 提供隔离的 iframe 环境
  - 管理 HTML、CSS、JavaScript 代码的注入
  - 错误捕获和状态管理

- **PreviewPage**：预览页面组件
  - 基于动态路由实现（[id].tsx）
  - 负责数据获取和状态管理
  - 集成沙箱容器组件

##### 安全机制
- iframe sandbox 属性限制：
  - `allow-scripts`：允许执行脚本
  - `allow-same-origin`：允许同源访问
  - 默认禁用其他权限（如弹窗、表单提交等）

- 代码执行隔离：
  - JavaScript 代码在独立作用域中执行
  - 使用 IIFE (Immediately Invoked Function Expression) 包装
  - 全局错误捕获和消息传递机制

#### 7.2 实现流程

1. **代码加载流程**
   - 通过 API 获取预览数据（HTML、CSS、JavaScript）
   - 构建完整的 HTML 文档结构
   - 注入重置样式和自定义样式
   - 包装 JavaScript 代码并添加错误处理

2. **错误处理机制**
   - JavaScript 运行时错误捕获
   - 使用 postMessage 进行父子框架通信
   - 错误信息展示和状态管理

3. **预览更新机制**
   - 监听代码内容变化
   - 重新构建和刷新预览内容
   - 清理和重置沙箱环境

#### 7.3 使用方式

```typescript
// 基础使用
<CodePreviewSandbox
  htmlContent={htmlCode}
  cssContent={cssCode}
  jsContent={jsCode}
  height="600px"
/>

// 带错误处理的使用示例
<CodePreviewSandbox
  htmlContent={htmlCode}
  cssContent={cssCode}
  jsContent={jsCode}
  onError={(error) => console.error('Preview Error:', error)}
/>
```

#### 7.4 注意事项

1. **安全考虑**
   - 避免执行不受信任的代码
   - 限制对敏感 API 的访问
   - 防止跨站脚本攻击（XSS）

2. **性能优化**
   - 合理控制更新频率
   - 避免频繁重建 iframe
   - 资源加载优化

3. **兼容性**
   - 确保跨浏览器兼容性
   - 处理不同设备和屏幕尺寸
   - 响应式设计支持